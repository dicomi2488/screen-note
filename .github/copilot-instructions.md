(## 目标)
(帮助 AI 代理快速上手并实现或维护 Screen Note — 一个以 overlay canvas + 浮动小圆球工具栏为核心的纯 Web 画板。)

(## 一眼看懂的架构要点)
( - UI（`src/ui/*`）只负责交互展示：`floating-button.js` 创建主圆球并在点击后展开工具按钮（data-tool 值如 `pen`/`pointer`/`undo`/`eraser`/`settings`）。)
( - Canvas 管理（`src/core/canvas-manager.js`）负责 overlay canvas 的创建、DPR 调整与基础绘制 API：startStroke/updateStroke/endStroke 和 exportImage。)
( - 工具实现（`src/core/pen-tool.js` 等）监听 pointer 事件并调用 canvas-manager 的 API；不要直接在 UI 层中操纵 canvas。)
( - 历史（`src/core/history-manager.js`）保留矢量 stroke（pushStroke/undo/redo），并通过 `bus` 通知变更。)
( - 事件总线（`src/core/event-bus.js`）是模块间通信的单一途径（emit/on/off）。)

(## 约定与风格)
( - 事件命名使用命名空间：例如 `tool:select`、`canvas:stroke:finished`、`history:undo`。)
( - DOM/CSS 命名统一使用 `sn-` 前缀以降低与宿主页面冲突（见 `src/ui/styles.css`）。)
( - 挂载点：UI 默认 append 到 `document.body`，Canvas 使用 fixed 全屏 overlay，默认允许 pointer 事件（指针透传通过工具切换处理）。)

(## 常见修改示例（要做什么、在哪里改）)
( - 添加新工具：在 `src/core` 新建 `your-tool.js`，实现 pointer 事件处理并调用 `canvasManager.startStroke/updateStroke/endStroke`；在 `src/ui/floating-button.js` 增加对应按钮（data-tool），并通过 `bus.emit('tool:select', {tool: 'your-tool'})` 触发。)
( - 修改撤回策略：编辑 `src/core/history-manager.js`。矢量化实现（当前）比位图快照省内存；若需要 simpler-but-heavier 实现，可在 `pushStroke` 同步保存 `canvas.toDataURL()` 或 imageData。)
( - 修复高 DPI 问题：查看 `src/core/canvas-manager.js` 的 `_onResize`，注意使用 `canvas.width/height` 按 DPR 设置并在 `ctx.scale(dpr,dpr)` 后重绘。)

(## 开发与调试（直接可用命令，Windows PowerShell）)
( - 无构建：直接打开 `index.html`。)
( - 使用本地服务：)
( ```powershell)
( npx http-server -c-1 .)
( # 或)
( python -m http.server 8000)
( ```)
( - 使用 live reload（可选）：)
( ```powershell)
( npm init -y; npm i -D live-server)
( npx live-server --open=./index.html)
( ```)

(## 代码示例（直接可搜索/使用）)
( - 选择工具（UI -> 业务）)
( ```js)
( bus.emit('tool:select', { tool: 'pen' });)
( ```)
( - Pen tool 使用 Canvas API（例）)
( ```js)
( const id = canvasManager.startStroke({ tool: 'pen', color: '#ff0', width: 4 });)
( canvasManager.updateStroke(id, { x, y, t: Date.now() });)
( canvasManager.endStroke(id);)
( ```)

(## 你需要注意的边界/约束)
( - 事件/模块不要形成循环依赖：通过 `bus` 传递而非直接 import 对方实例。)
( - 尽量用矢量化 stroke 保存历史（便于缩放、编辑）。)
( - 样式隔离通过 `sn-` 前缀；如果宿主页面使用 Shadow DOM，注意浮动按钮挂载点的 CSS 覆盖问题。)

(如果有想合并的本地团队规则或需要我把这份说明改成英文/更短或加上更多代码例子，请告诉我要点，我会迭代更新。)
