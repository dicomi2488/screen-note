<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Note</title>
    <link rel="stylesheet" href="src/ui/styles.css" />
</head>
<body>
    <div id="app-root"></div>

    <script type="module">
        import EventBus from './src/core/event-bus.js';
        import CanvasManager from './src/core/canvas-manager.js';
        import PenTool from './src/core/pen-tool.js';
        import EraserTool from './src/core/eraser-tool.js';
        import PointerTool from './src/core/pointer-tool.js';
        import HistoryManager from './src/core/history-manager.js';
        import StrokeIndex from './src/core/stroke-index.js';
        import FloatingButton from './src/ui/floating-button.js';
        import SettingsModal from './src/ui/settings-modal.js';

        // åˆå§‹åŒ–
        const bus = new EventBus();
        const canvasManager = new CanvasManager({ bus });
        const history = new HistoryManager({ bus });
        const strokeIndex = new StrokeIndex({ bus, history });
        const pen = new PenTool({ canvasManager, history, bus });
        const eraser = new EraserTool({ canvasManager, history, bus });
        const pointer = new PointerTool({ canvasManager, bus });
        const settings = new SettingsModal({ bus });
        const floating = new FloatingButton({ bus });
        
        console.log('[ScreenNote] UI å·²åˆ›å»º');

        // ç­‰å¾… Tauri API å’Œ DOM
        function init() {
            if (!window.__TAURI__) {
                setTimeout(init, 100);
                return;
            }
            
            const { invoke } = window.__TAURI__.core;
            console.log('[ScreenNote] Tauri API å·²å°±ç»ª');
            
            // ç­‰å¾… DOM æ¸²æŸ“
            setTimeout(async () => {
                // æ”¶é›† UI åŒºåŸŸ
                function collectRegions() {
                    const regions = [];
                    const expand = 1; // æ¯è¾¹æ‰©å±• 1pxï¼Œæ€»å…±å¤§ 2px
                    
                    // ä¸»æŒ‰é’®
                    if (floating?.root && document.body.contains(floating.root)) {
                        const rect = floating.root.getBoundingClientRect();
                        console.log('[collectRegions] ä¸»æŒ‰é’® rect:', rect);
                        if (rect.width > 0) {
                            regions.push({
                                x: Math.round(rect.left - expand),
                                y: Math.round(rect.top - expand),
                                width: Math.round(rect.width + expand * 2),
                                height: Math.round(rect.height + expand * 2)
                            });
                        }
                    } else {
                        console.warn('[collectRegions] ä¸»æŒ‰é’®æœªæ‰¾åˆ°ï¼floating.root:', floating?.root);
                    }
                    
                    // å·¥å…·æŒ‰é’®ï¼ˆç‹¬ç«‹å…ƒç´ ï¼‰
                    if (floating?._toolElements) {
                        floating._toolElements.forEach(wrapper => {
                            if (document.body.contains(wrapper)) {
                                const rect = wrapper.getBoundingClientRect();
                                if (rect.width > 0 && parseFloat(getComputedStyle(wrapper).opacity) > 0) {
                                    regions.push({
                                        x: Math.round(rect.left - expand),
                                        y: Math.round(rect.top - expand),
                                        width: Math.round(rect.width + expand * 2),
                                        height: Math.round(rect.height + expand * 2)
                                    });
                                }
                            }
                        });
                    }
                    
                    // ç”»ç¬”é¢æ¿
                    if (floating?.penPanel?.root?.classList.contains('is-visible')) {
                        const rect = floating.penPanel.root.getBoundingClientRect();
                        if (rect.width > 0) {
                            regions.push({
                                x: Math.round(rect.left - expand),
                                y: Math.round(rect.top - expand),
                                width: Math.round(rect.width + expand * 2),
                                height: Math.round(rect.height + expand * 2)
                            });
                        }
                    }
                    
                    // æ©¡çš®é¢æ¿
                    if (floating?.eraserPanel?.root?.classList.contains('is-visible')) {
                        const rect = floating.eraserPanel.root.getBoundingClientRect();
                        if (rect.width > 0) {
                            regions.push({
                                x: Math.round(rect.left - expand),
                                y: Math.round(rect.top - expand),
                                width: Math.round(rect.width + expand * 2),
                                height: Math.round(rect.height + expand * 2)
                            });
                        }
                    }
                    
                    return regions;
                }
                
                // å¯ç”¨é€ä¼ 
                async function enablePassthrough() {
                    const regions = collectRegions();
                    console.log('[ScreenNote] è®¾ç½®', regions.length, 'ä¸ªå¯äº¤äº’åŒºåŸŸ', regions);
                    await invoke('set_interactive_regions', { regions });
                    console.log('[ScreenNote] âœ… é€ä¼ å·²å¯ç”¨');
                }
                
                // ç¦ç”¨é€ä¼ 
                async function disablePassthrough() {
                    await invoke('clear_interactive_regions');
                    console.log('[ScreenNote] é€ä¼ å·²ç¦ç”¨');
                }
                
                // å·¥å…·åˆ‡æ¢
                let currentTool = 'pointer';
                
                bus.on('tool:select', async ({ tool }) => {
                    if (!tool) return;
                    
                    if (tool === 'undo') {
                        history.undo();
                        canvasManager.renderStrokes(history.past);
                        return;
                    }
                    
                if (tool === 'settings') {
                    await disablePassthrough();
                    settings.show();
                    return;
                }                    currentTool = tool;
                    pen.disable();
                    eraser.disable();
                    pointer.disable();
                    
                    if (tool === 'pen') {
                        pen.enable();
                        await disablePassthrough();
                    } else if (tool === 'eraser') {
                        eraser.enable();
                        await disablePassthrough();
                    } else if (tool === 'pointer') {
                        pointer.enable();
                        await enablePassthrough();
                    }
                });
                
                // é¢æ¿æ˜¾ç¤º/éšè—æ—¶åˆ·æ–°
                bus.on('ui:panel:show', async () => {
                    if (currentTool === 'pointer') {
                        setTimeout(() => enablePassthrough(), 100);
                    }
                });
                
                bus.on('ui:panel:hide', async () => {
                    if (currentTool === 'pointer') {
                        setTimeout(() => enablePassthrough(), 100);
                    }
                });
                
                // è®¾ç½®ç•Œé¢å…³é—­åŽè‡ªåŠ¨åˆ‡æ¢åˆ°å…‰æ ‡æ¨¡å¼
                bus.on('settings:closed', () => {
                    bus.emit('tool:select', { tool: 'pointer' });
                });
                
                // æµ®åŠ¨æŒ‰é’®å±•å¼€/æ”¶èµ·æ—¶åˆ·æ–°
                bus.on('ui:floating:toggle', async () => {
                    if (currentTool === 'pointer') {
                        // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼ˆä¸ºåŠ¨ç”»å¼€å§‹ç”Ÿæˆæ¡†ï¼‰
                        await enablePassthrough();
                        
                        // åŠ¨ç”»è¿›è¡Œæ—¶ + ç»“æŸåŽ 0.3s å†…å®žæ—¶è·Ÿè¸ª
                        const animationDuration = 300; // ms
                        const extraTrackingTime = 300; // åŠ¨ç”»ç»“æŸåŽç»§ç»­è·Ÿè¸ª 0.3s
                        const totalDuration = animationDuration + extraTrackingTime;
                        const startTime = Date.now();
                        
                        const trackAnimation = () => {
                            const elapsed = Date.now() - startTime;
                            if (elapsed < totalDuration) {
                                enablePassthrough();
                                requestAnimationFrame(trackAnimation);
                            } else {
                                // æœ€åŽåˆ·æ–°ä¸€æ¬¡
                                enablePassthrough();
                            }
                        };
                        
                        requestAnimationFrame(trackAnimation);
                    }
                });
                
                // èŠ‚æµå‡½æ•°ï¼šé¿å…é¢‘ç¹è°ƒç”¨
                let passthroughUpdateScheduled = false;
                function schedulePassthroughUpdate() {
                    if (!passthroughUpdateScheduled) {
                        passthroughUpdateScheduled = true;
                        requestAnimationFrame(() => {
                            enablePassthrough();
                            passthroughUpdateScheduled = false;
                        });
                    }
                }
                
                // æµ®åŠ¨æŒ‰é’®æ‹–åŠ¨åŽåˆ·æ–°ï¼ˆå®žæ—¶ï¼Œä½†ä½¿ç”¨ RAF èŠ‚æµï¼‰
                bus.on('ui:floating:moved', async () => {
                    if (currentTool === 'pointer') {
                        schedulePassthroughUpdate();
                    }
                });
                
                // é»˜è®¤å¯ç”¨æŒ‡é’ˆæ¨¡å¼
                pointer.enable();
                currentTool = 'pointer';
                await enablePassthrough();
                
                console.log('[ScreenNote] ðŸŽ¯ åˆå§‹åŒ–å®Œæˆ');
                
                // å¯¼å‡ºåˆ°å…¨å±€
                window.__screenNote = {
                    bus, canvasManager, history, pen, eraser, pointer, 
                    floating, settings, currentTool,
                    enablePassthrough, disablePassthrough
                };
                
            }, 200);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(init, 100));
        } else {
            setTimeout(init, 100);
        }
    </script>
</body>
</html>
